import http from "node:http";
import { URL } from "node:url";

export default function express() {
  const routes = [];

  function app(req, res) {
    const url = new URL(req.url || "/", `http://${req.headers.host || "localhost"}`);
    for (const r of routes) {
      if (r.method !== req.method) continue;
      if (r.path !== url.pathname) continue;
      req.query = Object.fromEntries(url.searchParams.entries());
      res.status = (code) => { res.statusCode = code; return res; };
      res.send = (body) => { res.end(body); };
      res.json = (obj) => { res.setHeader("content-type", "application/json"); res.end(JSON.stringify(obj)); };
      return r.handler(req, res);
    }
    res.statusCode = 404;
    res.end("not found");
  }

  app.get = (path, handler) => routes.push({ method: "GET", path, handler });
  app.listen = (port, host, cb) => {
    if (typeof host === "function") { cb = host; host = "0.0.0.0"; }
    const srv = http.createServer(app);
    return srv.listen(port, host || "0.0.0.0", cb);
  };

  return app;
}

